import { Head } from "mdx-deck";
import {
  CodeSurfer,
  CodeSurferColumns,
  Step,
} from "code-surfer";
import { github, nightOwl } from "@code-surfer/themes";

import jcs from './jscodeshift.png';
import ast from './ast.png'
import jsx1 from './jsx-1.png';
import jsx2 from './jsx-2.png';
import jsx3 from './jsx-3.png';
import jsx4 from './jsx-4.png';

export const theme = nightOwl;

<Head>
  <title>Refactoring with jscodeshift</title>
</Head>

# Hello!

---

# jscodeshift + <img style={{width: '185px', position: 'relative', top: "18px"}} src="https://ink.carta.com/fonts/ink_white.svg" />

## Robots taking our jobs ðŸ¤–

### Pain-free (for you) Ink upgrades

---

# Rodrigo Deodoro

![profile picture](https://ca.slack-edge.com/T02ALE3NE-U0U9655HS-2a18106ee26a-512 "Profile")

- Been @ Carta for ~4 years
- Tech lead @ Design Technology

---

# The problem:

Making **major** or even **minor** changes reliably <br/> across all of `carta-web`.

---

...and we're gonna make a ton of changes.

---

## changes such as:

<ul>
  <Appear>
    <li>Non-intuitive prop names</li>
    <li>Invalid default values</li>
    <li>Conflicts of responsibility</li>
    <li>...and more</li>
  </Appear>
</ul>

---

<iframe
  style={{width: '90vw', height: '90vh'}}
  src='https://docs.google.com/spreadsheets/d/e/2PACX-1vRNqq_w-utvpiklBb3-xIpmAt9gO9aig1NHWQ3jsviK_-ovYStFNE1h_0InwibOzfn247hVof5nxLDz/pubhtml?widget=true&amp;headers=false
'></iframe>

---

<CodeSurfer>

```jsx
<Display when={!isLoading}>
  <Belt noMargins>
    <Dropdown isDisabled />
  </Belt>
</Display>
```

```jsx 3
<Display when={!isLoading}>
  <Belt noMargins>
    <Dropdown isDisabled />
  </Belt>
</Display>
```

```jsx 3
<Display when={!isLoading}>
  <Belt noMargins>
    <Dropdown disabled />
  </Belt>
</Display>
```

```jsx 2
<Display when={!isLoading}>
  <Belt noMargins>
    <Dropdown disabled />
  </Belt>
</Display>
```

```jsx
<Display when={!isLoading}>
  <Belt>
    <Dropdown disabled />
  </Belt>
</Display>
```

```jsx 1,5
<Display when={!isLoading}>
  <Belt>
    <Dropdown disabled />
  </Belt>
</Display>
```

```jsx
{ !isLoading &&
  <Belt>
    <Dropdown disabled />
  </Belt>
}
```

```jsx 1:5
{ !isLoading &&
  <Belt>
    <Dropdown disabled />
  </Belt>
}
```

</CodeSurfer>

---

# Thousands of lines of changes

## Refactoring at scale

---

<img
    style={{
        maxWidth: '100vw',
        maxHeight: '100vh',
    }}
    src={jcs}
/>

---


# How does jscodeshift work?

---

# Enter the AST

## Abstract Syntax Tree

---

# The AST
## is how the interpreter sees code

##### (sort of)

---

<iframe
  style={{ width: '95vw', height: '95vh', border: 0}}
  src='https://rezmason.github.io/matrix/'
></iframe>

---

<CodeSurferColumns>

<Step>

```js
function sayHello(name) {
  alert('Hello ' + name);
}

```

<img
 style={{ height: '90vh', }}
 src={ ast }
/>

</Step>

</CodeSurferColumns>

---

<CodeSurfer>

```js title="Where we start"
function sayHello(name) {
  alert('Hello ' + name);
}
```

```js title="Where we want to end"
function sayGoodbye(name) {
  alert('Bye, ' + name);
}
```

</CodeSurfer>

---

<CodeSurfer>

```js title="Transform template"
export default function transformer(file, api) {
    const j = api.jscodeshift;
    const root = j(file.source);

    { ... }

    return root.toSource();
}
```

```js
export default function transformer(file, api) {
    const j = api.jscodeshift;
    const root = j(file.source);

    root

    return root.toSource();
}
```

```js
export default function transformer(file, api) {
    const j = api.jscodeshift;
    const root = j(file.source);

    root
      .find(j.FunctionDeclaration, {id: {name: 'sayHello'}})

    return root.toSource();
}
```

```js
export default function transformer(file, api) {
    const j = api.jscodeshift;
    const root = j(file.source);

    root
      .find(j.FunctionDeclaration, {id: {name: 'sayHello'}})
      .find(j.Literal, {value: 'Hello '})

    return root.toSource();
}
```

```js
export default function transformer(file, api) {
    const j = api.jscodeshift;
    const root = j(file.source);

    root
      .find(j.FunctionDeclaration, {id: {name: 'sayHello'}})
      .find(j.Literal, {value: 'Hello '})
      .forEach(node => j(node).replaceWith('"Bye, "'))

    return root.toSource();
}
```

```js 1:11
export default function transformer(file, api) {
    const j = api.jscodeshift;
    const root = j(file.source);

    root
      .find(j.FunctionDeclaration, {id: {name: 'sayHello'}})
      .find(j.Literal, {value: 'Hello '})
      .forEach(node => j(node).replaceWith('"Bye, "'))

    return root.toSource();
}
```

</CodeSurfer>

---

<CodeSurfer>

```js
function sayHello(name) {
  alert("Hello, " + name);
}
```

```js
function sayHello(name) {
  alert("Bye, " + name);
}
```

</CodeSurfer>

---

<CodeSurfer>

```js
export default function transformer(file, api) {
    const j = api.jscodeshift;
    const root = j(file.source);

    root
      .find(j.FunctionDeclaration, {id: {name: 'sayHello'}})
      .find(j.Literal, {value: 'Hello '})
      .forEach(node => j(node).replaceWith('"Bye, "'))

    return root.toSource();
}
```

```js
export default function transformer(file, api) {
    const j = api.jscodeshift;
    const root = j(file.source);

    const func = root.find(j.FunctionDeclaration, {id: {name: 'sayHello'}})

    func
      .find(j.Literal, {value: 'Hello '})
      .forEach(node => j(node).replaceWith('"Bye, "'))

    return root.toSource();
}
```

```js
export default function transformer(file, api) {
    const j = api.jscodeshift;
    const root = j(file.source);

    const func = root.find(j.FunctionDeclaration, {id: {name: 'sayHello'}})

    func
      .find(j.Literal, {value: 'Hello '})
      .forEach(node => j(node).replaceWith('"Bye, "'))

    func

    return root.toSource();
}
```

```js
export default function transformer(file, api) {
    const j = api.jscodeshift;
    const root = j(file.source);

    const func = root.find(j.FunctionDeclaration, {id: {name: 'sayHello'}})

    func
      .find(j.Literal, {value: 'Hello '})
      .forEach(node => j(node).replaceWith('"Bye, "'))

    func
      .find(j.Identifier, {name: 'sayHello'})

    return root.toSource();
}
```

```js
export default function transformer(file, api) {
    const j = api.jscodeshift;
    const root = j(file.source);

    const func = root.find(j.FunctionDeclaration, {id: {name: 'sayHello'}})

    func
      .find(j.Literal, {value: 'Hello '})
      .forEach(node => j(node).replaceWith('"Bye, "'))

    func
      .find(j.Identifier, {name: 'sayHello'})
      .forEach(node => j(node).replaceWith("sayGoodbye"));

    return root.toSource();
}
```

</CodeSurfer>

---

# Live demo

https://astexplorer.net/

<small>
  <a href="https://astexplorer.net/#/gist/6d14b47e8433ff5ef53852ae7e2ae9d8/738e2835d1afda32b5895f7de459a2bd35b3a56a">or click here for the final result</a>
</small>

---

# But what about JSX?

---

<img src={jsx1} />

---

<img src={jsx2} />

---

<img src={jsx3} />

---

<img src={jsx4} />

---

<CodeSurferColumns>

<Step>

```js
import {
  Dropdown,
  Belt,
  Display
} from '@carta/ink';

export default ({ isLoading }) => (
  <Display when={ !isLoading }>
    <Belt noMargins>
      <Dropdown isDisabled />
    </Belt>
  </Display>
)
```

```js subtitle="Starting with our transformer template"
export default function transformer(file, api) {
    const j = api.jscodeshift;
    const root = j(file.source);

    { ... }

    return root.toSource();
}
```

</Step>

<Step>

```js 10[16:26] subtitle="And what we want to do is replace the isDisabled with disabled"
import {
  Dropdown,
  Belt,
  Display
} from '@carta/ink';

export default ({ isLoading }) => (
  <Display when={ !isLoading }>
    <Belt noMargins>
      <Dropdown isDisabled />
    </Belt>
  </Display>
)
```

```js
export default function transformer(file, api) {
    const j = api.jscodeshift;
    const root = j(file.source);

    { ... }

    return root.toSource();
}
```

</Step>

<Step>

```js
import {
  Dropdown,
  Belt,
  Display
} from '@carta/ink';

export default ({ isLoading }) => (
  <Display when={ !isLoading }>
    <Belt noMargins>
      <Dropdown isDisabled />
    </Belt>
  </Display>
)
```

```js subtitle="We start a chain from root"
export default function transformer(file, api) {
    const j = api.jscodeshift;
    const root = j(file.source);

    root

    return root.toSource();
}
```

</Step>

<Step>

```js 10
import {
  Dropdown,
  Belt,
  Display
} from '@carta/ink';

export default ({ isLoading }) => (
  <Display when={ !isLoading }>
    <Belt noMargins>
      <Dropdown isDisabled />
    </Belt>
  </Display>
)
```

```js subtitle="...then make a query for opening JSX tags called 'Dropdown'"
export default function transformer(file, api) {
    const j = api.jscodeshift;
    const root = j(file.source);

    root
      .find(j.JSXElement, { openingElement: { name: { name: 'Dropdown' } } })

    return root.toSource();
}
```

</Step>

<Step>

```js 10[16:26]
import {
  Dropdown,
  Belt,
  Display
} from '@carta/ink';

export default ({ isLoading }) => (
  <Display when={ !isLoading }>
    <Belt noMargins>
      <Dropdown isDisabled />
    </Belt>
  </Display>
)
```

```js subtitle="...who have the 'isDisabled' attribute, or prop"
export default function transformer(file, api) {
    const j = api.jscodeshift;
    const root = j(file.source);

    root
      .find(j.JSXElement, { openingElement: { name: { name: 'Dropdown' } } })
      .find(j.JSXAttribute, { name: { name: 'isDisabled' } })

    return root.toSource();
}
```

</Step>

<Step>

```js 10[16:24]
import {
  Dropdown,
  Belt,
  Display
} from '@carta/ink';

export default ({ isLoading }) => (
  <Display when={ !isLoading }>
    <Belt noMargins>
      <Dropdown disabled />
    </Belt>
  </Display>
)
```

```js subtitle="and replace it with 'disabled'"
export default function transformer(file, api) {
    const j = api.jscodeshift;
    const root = j(file.source);

    root
      .find(j.JSXElement, { openingElement: { name: { name: 'Dropdown' } } })
      .find(j.JSXAttribute, { name: { name: 'isDisabled' } })
      .forEach(e => j(e).replaceWith('disabled'))

    return root.toSource();
}
```

</Step>

<Step>

```js
import {
  Dropdown,
  Belt,
  Display
} from '@carta/ink';

export default ({ isLoading }) => (
  <Display when={ !isLoading }>
    <Belt noMargins>
      <Dropdown disabled />
    </Belt>
  </Display>
)
```

```js subtitle="And we're done!"
export default function transformer(file, api) {
    const j = api.jscodeshift;
    const root = j(file.source);

    root
      .find(j.JSXElement, { openingElement: { name: { name: 'Dropdown' } } })
      .find(j.JSXAttribute, { name: { name: 'isDisabled' } })
      .forEach(e => j(e).replaceWith('disabled'))

    return root.toSource();
}
```

</Step>

<Step>

```js 6[1:2]
import {
  Dropdown,
  Belt,
  Display
} from '@carta/ink';

export default ({ isLoading }) => (
  <Display when={ !isLoading }>
    <Belt noMargins>
      <Dropdown disabled />
    </Belt>
  </Display>
)
```

```js 5:8 subtitle="And if we abstract this chain..."
export default function transformer(file, api) {
    const j = api.jscodeshift;
    const root = j(file.source);

    root
      .find(j.JSXElement, { openingElement: { name: { name: 'Dropdown' } } })
      .find(j.JSXAttribute, { name: { name: 'isDisabled' } })
      .forEach(e => j(e).replaceWith('disabled'))

    return root.toSource();
}
```

</Step>

<Step>

```js 6[1:2]
import {
  Dropdown,
  Belt,
  Display
} from '@carta/ink';

export default ({ isLoading }) => (
  <Display when={ !isLoading }>
    <Belt noMargins>
      <Dropdown disabled />
    </Belt>
  </Display>
)
```

```js 5:8 subtitle="by using named parameters"
export default function transformer(file, api) {
    const j = api.jscodeshift;
    const root = j(file.source);

    root
      .find(j.JSXElement, { openingElement: { name: { name: elName } } })
      .find(j.JSXAttribute, { name: { name: 'isDisabled' } })
      .forEach(e => j(e).replaceWith('disabled'))

    return root.toSource();
}
```

</Step>

<Step>

```js 6[1:2]
import {
  Dropdown,
  Belt,
  Display
} from '@carta/ink';

export default ({ isLoading }) => (
  <Display when={ !isLoading }>
    <Belt noMargins>
      <Dropdown disabled />
    </Belt>
  </Display>
)
```

```js 5:8
export default function transformer(file, api) {
    const j = api.jscodeshift;
    const root = j(file.source);

    root
      .find(j.JSXElement, { openingElement: { name: { name: elName } } })
      .find(j.JSXAttribute, { name: { name: before } })
      .forEach(e => j(e).replaceWith('disabled'))

    return root.toSource();
}
```

</Step>

<Step>

```js 6[1:2]
import {
  Dropdown,
  Belt,
  Display
} from '@carta/ink';

export default ({ isLoading }) => (
  <Display when={ !isLoading }>
    <Belt noMargins>
      <Dropdown disabled />
    </Belt>
  </Display>
)
```

```js 5:8
export default function transformer(file, api) {
    const j = api.jscodeshift;
    const root = j(file.source);

    root
      .find(j.JSXElement, { openingElement: { name: { name: elName } } })
      .find(j.JSXAttribute, { name: { name: before } })
      .forEach(e => j(e).replaceWith(after))

    return root.toSource();
}
```

</Step>

<Step>

```js
import {
  Dropdown,
  Belt,
  Display
} from '@carta/ink';

export default ({ isLoading }) => (
  <Display when={ !isLoading }>
    <Belt noMargins>
      <Dropdown disabled />
    </Belt>
  </Display>
)
```

```js 1:6,12
function renameProp(j, root, name, oldProp, newProp) {
  root
    .find(j.JSXElement, { openingElement: { name: { name: elName } } })
    .find(j.JSXAttribute, { name: { name: before } })
    .forEach(e => j(e).replaceWith(after))
}

export default function transformer(file, api) {
    const j = api.jscodeshift;
    const root = j(file.source);

    renameProp(j, root, 'Dropdown', 'isDisabled', 'disabled')

    return root.toSource();
}
```

</Step>

<Step>

```js
import {
  Dropdown,
  Belt,
  Display
} from '@carta/ink';

export default ({ isLoading }) => (
  <Display when={ !isLoading }>
    <Belt >
      <Dropdown disabled />
    </Belt>
  </Display>
)
```

```js subtitle="We've now refactored <Belt /> with only an extra line"
function renameProp(j, root, name, oldProp, newProp) {
  root
    .find(j.JSXElement, { openingElement: { name: { name: elName } } })
    .find(j.JSXAttribute, { name: { name: before } })
    .forEach(e => j(e).replaceWith(after))
}

export default function transformer(file, api) {
    const j = api.jscodeshift;
    const root = j(file.source);

    renameProp(j, root, 'Dropdown', 'isDisabled', 'disabled')
    renameProp(j, root, 'Belt', 'noMargins', null)

    return root.toSource();
}
```

</Step>

</CodeSurferColumns>

---

# But what about the `<Display />`

---

<CodeSurferColumns>

<Step>

```js 8,12
import {
  Dropdown,
  Belt,
  Display
} from '@carta/ink';

export default ({ isLoading }) => (
  <Display when={ !isLoading }>
    <Belt >
      <Dropdown disabled />
    </Belt>
  </Display>
)
```

```js 7[1]
function renameProp(j, root, name, oldProp, newProp) {
  root
    .find(j.JSXElement, { openingElement: { name: { name: elName } } })
    .find(j.JSXAttribute, { name: { name: before } })
    .forEach(e => j(e).replaceWith(after))
}

export default function transformer(file, api) {
    const j = api.jscodeshift;
    const root = j(file.source);

    renameProp(j, root, 'Dropdown', 'isDisabled', 'disabled')
    renameProp(j, root, 'Belt', 'noMargins', null)

    return root.toSource();
}
```

</Step>

<Step>

```js 8[11:28]
import {
  Dropdown,
  Belt,
  Display
} from '@carta/ink';

export default ({ isLoading }) => (
  <Display when={ !isLoading }>
    <Belt >
      <Dropdown disabled />
    </Belt>
  </Display>
)
```

```js
export default function transformer(file, api) {
    const j = api.jscodeshift;
    const root = j(file.source);

    root

    return root.toSource();
}
```

</Step>

<Step>

```js 8,12
import {
  Dropdown,
  Belt,
  Display
} from '@carta/ink';

export default ({ isLoading }) => (
  <Display when={ !isLoading }>
    <Belt >
      <Dropdown disabled />
    </Belt>
  </Display>
)
```

```js
export default function transformer(file, api) {
    const j = api.jscodeshift;
    const root = j(file.source);

    root
      .find(j.JSXElement, { openingElement: { name: { name: "Display" } } })

    return root.toSource();
}
```

</Step>

<Step>

```js 8,12
import {
  Dropdown,
  Belt,
  Display
} from '@carta/ink';

export default ({ isLoading }) => (
  <Display when={ !isLoading }>
    <Belt >
      <Dropdown disabled />
    </Belt>
  </Display>
)
```

```js
export default function transformer(file, api) {
    const j = api.jscodeshift;
    const root = j(file.source);

    root
      .find(j.JSXElement, { openingElement: { name: { name: "Display" } } })
      .forEach(display => {

      })

    return root.toSource();
}
```

</Step>

<Step>

```js 8,12
import {
  Dropdown,
  Belt,
  Display
} from '@carta/ink';

export default ({ isLoading }) => (
  <Display when={ !isLoading }>
    <Belt >
      <Dropdown disabled />
    </Belt>
  </Display>
)
```

```js 7[15:22]
export default function transformer(file, api) {
    const j = api.jscodeshift;
    const root = j(file.source);

    root
      .find(j.JSXElement, { openingElement: { name: { name: "Display" } } })
      .forEach(display => {

      })

    return root.toSource();
}
```

</Step>

<Step>

```js 8,12
import {
  Dropdown,
  Belt,
  Display
} from '@carta/ink';

export default ({ isLoading }) => (
  <Display when={ !isLoading }>
    <Belt >
      <Dropdown disabled />
    </Belt>
  </Display>
)
```

```js
export default function transformer(file, api) {
    const j = api.jscodeshift;
    const root = j(file.source);

    root
      .find(j.JSXElement, { openingElement: { name: { name: "Display" } } })
      .forEach(display => {
        const displayNode = display.node;
      })

    return root.toSource();
}
```

</Step>

<Step>

```js 8[11:30]
import {
  Dropdown,
  Belt,
  Display
} from '@carta/ink';

export default ({ isLoading }) => (
  <Display when={ !isLoading }>
    <Belt >
      <Dropdown disabled />
    </Belt>
  </Display>
)
```

```js
export default function transformer(file, api) {
    const j = api.jscodeshift;
    const root = j(file.source);

    root
      .find(j.JSXElement, { openingElement: { name: { name: "Display" } } })
      .forEach(display => {
        const displayNode = display.node;

        const condition = displayNode.openingElement.attributes.find(attr => attr.name.name === 'when').value;
      })

    return root.toSource();
}
```

</Step>

<Step>

```js 9,10,11
import {
  Dropdown,
  Belt,
  Display
} from '@carta/ink';

export default ({ isLoading }) => (
  <Display when={ !isLoading }>
    <Belt >
      <Dropdown disabled />
    </Belt>
  </Display>
)
```

```js
export default function transformer(file, api) {
    const j = api.jscodeshift;
    const root = j(file.source);

    root
      .find(j.JSXElement, { openingElement: { name: { name: "Display" } } })
      .forEach(display => {
        const displayNode = display.node;

        const condition = displayNode.openingElement.attributes.find(attr => attr.name.name === 'when').value;
        const children = displayNode.children.find(e => e.type === 'JSXElement');
      })

    return root.toSource();
}
```

</Step>

<Step>

```js 8[18:28]
import {
  Dropdown,
  Belt,
  Display
} from '@carta/ink';

export default ({ isLoading }) => (
  <Display when={ !isLoading }>
    <Belt >
      <Dropdown disabled />
    </Belt>
  </Display>
)
```

```js
export default function transformer(file, api) {
    const j = api.jscodeshift;
    const root = j(file.source);

    root
      .find(j.JSXElement, { openingElement: { name: { name: "Display" } } })
      .forEach(display => {
        const displayNode = display.node;

        const condition = displayNode.openingElement.attributes.find(attr => attr.name.name === 'when').value;
        const children = displayNode.children.find(e => e.type === 'JSXElement');

        const boolExprNode = j.logicalExpression("&&", condition.expression, children);
      })

    return root.toSource();
}
```

</Step>

<Step>

```js 8,9,10
import {
  Dropdown,
  Belt,
  Display
} from '@carta/ink';

export default ({ isLoading }) => (
  !isLoading && <Belt >
    <Dropdown isDisabled />
  </Belt>
)
```

```js
export default function transformer(file, api) {
    const j = api.jscodeshift;
    const root = j(file.source);

    root
      .find(j.JSXElement, { openingElement: { name: { name: "Display" } } })
      .forEach(display => {
        const displayNode = display.node;

        const condition = displayNode.openingElement.attributes.find(attr => attr.name.name === 'when').value;
        const children = displayNode.children.find(e => e.type === 'JSXElement');

        const boolExprNode = j.logicalExpression("&&", condition.expression, children);

        display.replace(boolExprNode)
      })

    return root.toSource();
}
```

</Step>

</CodeSurferColumns>

---

<CodeSurfer>

```js
import {
  Dropdown,
  Belt,
  Display
} from '@carta/ink';

export default ({ isLoading }) => (
  !isLoading && <Belt >
    <Dropdown isDisabled />
  </Belt>
)
```

```js
import { Dropdown, Belt, Display } from "@carta/ink";

export default ({ isLoading }) =>
  !isLoading && (
    <Belt>
      <Dropdown isDisabled />
    </Belt>
  );
```

```js
import { Dropdown, Belt } from "@carta/ink";

export default ({ isLoading }) =>
  !isLoading && (
    <Belt>
      <Dropdown isDisabled />
    </Belt>
  );
```

```js
import { Dropdown, Belt } from "@carta/ink";

export default ({ isLoading }) =>
  !isLoading && (
    <Belt>
      <Dropdown isDisabled />
    </Belt>
  );
```

</CodeSurfer>
